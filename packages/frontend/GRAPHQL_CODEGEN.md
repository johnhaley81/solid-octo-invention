# GraphQL Code Generator Setup

This document explains how to use the GraphQL Code Generator setup for type-safe GraphQL operations in the frontend.

## Overview

We use [GraphQL Code Generator](https://the-guild.dev/graphql/codegen) to automatically generate TypeScript types and typed Apollo Client hooks from our GraphQL schema and operations.

## How It Works

1. **Schema Source**: The GraphQL schema is generated by PostGraphile from our PostgreSQL database and saved to `packages/backend/schema.graphql`
2. **Operation Discovery**: Code Generator scans all `.ts` and `.tsx` files in the frontend for GraphQL operations (queries, mutations, subscriptions)
3. **Type Generation**: TypeScript types and typed Apollo hooks are generated in `src/generated/graphql.ts`

## Configuration

The configuration is defined in `codegen.yml`:

```yaml
overwrite: true
schema: "../backend/schema.graphql"
documents: "src/**/*.{ts,tsx}"
generates:
  src/generated/graphql.ts:
    plugins:
      - "typescript"
      - "typescript-operations"
      - "typescript-react-apollo"
    config:
      withHooks: true
      withHOC: false
      withComponent: false
      apolloReactHooksImportFrom: "@apollo/client"
      scalars:
        UUID: string
        DateTime: string
        Date: string
        Time: string
        JSON: any
        BigInt: string
        BigFloat: string
        Cursor: string
hooks:
  afterAllFileWrite:
    - prettier --write
```

## Available Scripts

```bash
# Generate types from schema and operations
pnpm codegen

# Watch mode - regenerate types when files change
pnpm codegen:watch

# Generate schema + frontend types (from root)
pnpm codegen
```

## Usage Examples

### Basic Query Hook

```typescript
import { useGetUserByIdQuery } from '../generated/graphql';

function UserProfile({ userId }: { userId: string }) {
  const { data, loading, error } = useGetUserByIdQuery({
    variables: { id: userId },
  });

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  if (!data?.userById) return <div>User not found</div>;

  // TypeScript knows the exact shape of data.userById
  return (
    <div>
      <h1>{data.userById.name}</h1>
      <p>{data.userById.email}</p>
    </div>
  );
}
```

### Mutation Hook

```typescript
import { useUpdateUserProfileMutation } from '../generated/graphql';

function EditProfile({ userNodeId }: { userNodeId: string }) {
  const [updateProfile, { loading, error }] = useUpdateUserProfileMutation();

  const handleSubmit = async (name: string, avatarUrl: string) => {
    try {
      const result = await updateProfile({
        variables: {
          nodeId: userNodeId,
          name,
          avatarUrl,
        },
      });
      
      // TypeScript knows the exact shape of result.data
      console.log('Updated user:', result.data?.updateUser?.user);
    } catch (err) {
      console.error('Update failed:', err);
    }
  };

  // ... rest of component
}
```

### Lazy Query Hook

```typescript
import { useGetUserByEmailLazyQuery } from '../generated/graphql';

function UserSearch() {
  const [searchUser, { data, loading, error }] = useGetUserByEmailLazyQuery();

  const handleSearch = (email: string) => {
    searchUser({ variables: { email } });
  };

  // ... rest of component
}
```

## Type Safety Benefits

1. **Compile-time Validation**: TypeScript will catch errors if you try to access fields that don't exist
2. **IntelliSense**: Full autocomplete support for all GraphQL fields and operations
3. **Refactoring Safety**: Renaming fields in the schema will cause TypeScript errors until all usages are updated
4. **Variable Type Safety**: Query/mutation variables are fully typed

## Generated Files

- `src/generated/graphql.ts` - Contains all generated types and hooks
- This file is automatically regenerated and should not be edited manually
- Add it to `.gitignore` if you prefer to generate it during build, or commit it for faster builds

## Integration with Build Process

The codegen is integrated into the build process:

1. **Development**: Run `pnpm codegen:watch` to automatically regenerate types as you write queries
2. **Build**: The frontend build script automatically runs codegen before TypeScript compilation
3. **CI**: The CI process ensures the schema is up-to-date and generates fresh types

## Best Practices

1. **Centralize Operations**: Keep GraphQL operations in `src/graphql/` for better organization
2. **Use Fragments**: Create reusable fragments for common field sets
3. **Name Operations**: Always name your queries and mutations for better generated hook names
4. **Type Variables**: Use the generated types for component props that accept GraphQL data

```typescript
import { GetUserQuery } from '../generated/graphql';

// Use the generated type for props
interface UserCardProps {
  user: GetUserQuery['userById'];
}

function UserCard({ user }: UserCardProps) {
  if (!user) return null;
  
  return (
    <div>
      <h3>{user.name}</h3>
      <p>{user.email}</p>
    </div>
  );
}
```

## Troubleshooting

### Schema Validation Errors

If you get validation errors during codegen:

1. Check that your GraphQL operations match the schema in `packages/backend/schema.graphql`
2. Ensure the backend schema is up-to-date by running `pnpm schema:generate`
3. Verify field names, argument types, and required fields match the schema

### Missing Types

If generated types are missing:

1. Ensure your GraphQL operations are in files with `.ts` or `.tsx` extensions
2. Check that operations are properly formatted with `gql` template literals
3. Verify the `documents` pattern in `codegen.yml` matches your file structure

### Build Errors

If the build fails due to codegen:

1. Run `pnpm codegen` manually to see detailed error messages
2. Check that the backend schema file exists and is readable
3. Ensure all required dependencies are installed

## Schema Updates

When the backend schema changes:

1. **Automatic**: The schema is automatically updated during backend development
2. **Manual**: Run `pnpm schema:generate` to update the schema file
3. **Regenerate**: Run `pnpm codegen` to update frontend types
4. **Fix Errors**: Update any GraphQL operations that no longer match the schema

This ensures your frontend stays in sync with backend changes and maintains type safety throughout development.

