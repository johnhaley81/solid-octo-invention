---
description: Backend architecture and development guidelines for PostGraphile + Effect-TS
globs: ["packages/backend/**/*"]
alwaysApply: true
---

# Backend Development Guidelines

## Architecture

The backend uses the Graphile stack with Effect-TS for functional programming:

- **PostGraphile**: Automatic GraphQL API generation from PostgreSQL schema
- **Graphile Worker**: Background job processing
- **Graphile Migrate**: Database schema management
- **Effect-TS**: Functional programming and type-safe effects

## Service Layer Pattern

All business logic should be implemented as Effect-TS services:

```typescript
import { Effect, Context } from 'effect';

// Define service interface
export interface DatabaseService {
  readonly query: (text: string, params?: unknown[]) => Effect.Effect<unknown[], DatabaseError>;
}

// Service tag for dependency injection
export const DatabaseService = Context.GenericTag<DatabaseService>('DatabaseService');

// Implementation
export const makeDatabaseService = (): DatabaseService => ({
  query: (text, params) => 
    Effect.tryPromise({
      try: () => pool.query(text, params),
      catch: (error) => new DatabaseError('Query failed', error),
    }),
});
```

## Error Handling

Use tagged errors with Effect-TS:

```typescript
export class DatabaseError extends Error {
  readonly _tag = 'DatabaseError';
  public readonly errorCause?: unknown;
  
  constructor(message: string, cause?: unknown) {
    super(message);
    this.errorCause = cause;
  }
}
```

## Database Guidelines

- Use PostgreSQL with Row Level Security (RLS)
- Implement proper indexes and constraints
- Use UUID primary keys for better distribution
- Add automatic timestamps with triggers
- Keep schema simple and focused on core domain

## ğŸš« PROHIBITED PATTERNS

### REST API Endpoints
- **âŒ NO REST endpoints** - All API interactions must go through GraphQL
- **âŒ NO Express routes** for business logic (except health checks)
- **âŒ NO custom middleware** for authentication - use PostGraphile's built-in features
- **âŒ NO `/api/*` routes** - everything should be accessible via `/graphql`

### Database Schema Violations
- **âŒ NO boolean columns** - use `TIMESTAMPTZ` columns instead (e.g., `email_verified_at` not `email_verified`)
- **âŒ NO TEXT columns with CHECK constraints** - use PostgreSQL ENUMs for better GraphQL type generation
- **âŒ NO separate migration files** - all schema changes go in `current.sql`
- **âŒ NO sensitive data in public schema** - use `app_private` schema for authentication tables

### Background Processing Anti-patterns
- **âŒ NO database functions for background tasks** - use graphile-worker jobs
- **âŒ NO cron-like database functions** - schedule jobs through graphile-worker
- **âŒ NO direct database cleanup functions** - implement as worker tasks

## âœ… REQUIRED PATTERNS

### GraphQL-First Architecture
- **âœ… USE PostGraphile functions** for custom mutations and queries
- **âœ… USE PostgreSQL functions** with `SECURITY DEFINER` for business logic
- **âœ… USE GraphQL mutations** for all user actions
- **âœ… EXPOSE functions** via PostGraphile's automatic schema generation

### Database Schema Best Practices
- **âœ… USE `app_private` schema** for sensitive authentication data
- **âœ… USE PostgreSQL ENUMs** instead of TEXT with CHECK constraints
- **âœ… USE TIMESTAMPTZ columns** instead of boolean flags
- **âœ… USE `current.sql`** as the single source of truth for schema
- **âœ… USE Row Level Security (RLS)** for data access control

### Background Processing
- **âœ… USE graphile-worker** for all background tasks
- **âœ… USE worker jobs** for email sending, cleanup, notifications
- **âœ… USE scheduled jobs** for periodic maintenance tasks
- **âœ… IMPLEMENT task handlers** in the worker service

### Authentication Patterns
- **âœ… USE PostgreSQL functions** for authentication logic
- **âœ… USE `app_private` schema** for credentials and sessions
- **âœ… USE PostGraphile's pgSettings** for user context
- **âœ… USE RLS policies** with `current_setting('app.current_user_id')`

## Testing

- Write unit tests for all services
- Use Vitest for testing framework
- Mock external dependencies with Effect-TS
- Test error scenarios and edge cases

## File Organization

```
src/
â”œâ”€â”€ services/         # Effect-TS services
â”œâ”€â”€ types/           # Backend-specific types
â”œâ”€â”€ utils/           # Utility functions
â””â”€â”€ server.ts        # Express server setup
```
