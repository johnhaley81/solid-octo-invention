# GraphQL Schema Validation

This document explains the GraphQL schema validation process implemented in this
project to ensure schema stability and prevent breaking changes.

## Overview

The GraphQL schema is automatically generated by PostGraphile based on the
PostgreSQL database schema. To ensure stability and prevent accidental breaking
changes, we maintain a committed `schema.graphql` file that serves as a baseline
for validation.

## How It Works

1. **Schema Generation**: The `schema.graphql` file is automatically generated
   by PostGraphile when the backend server starts in development, test, or CI
   environments.

2. **CI Validation**: During CI builds, we:

   - Set up a fresh PostgreSQL database
   - Run all database migrations
   - Generate a new GraphQL schema
   - Compare it with the committed `schema.graphql` file
   - Fail the build if there are any differences

3. **Breaking Change Detection**: Any changes to the GraphQL schema will cause
   the CI build to fail, alerting developers to potential breaking changes.

## Files

- `packages/backend/schema.graphql` - The committed baseline schema file
- `packages/backend/scripts/generate-schema.ts` - Script for generating the
  schema
- `.github/workflows/ci.yml` - CI configuration with schema validation job

## Commands

```bash
# Generate GraphQL schema locally
pnpm schema:generate

# Generate schema for backend only
pnpm --filter backend schema:generate
```

## Updating the Schema

When you make database schema changes via migrations:

1. **Make your database changes** using Graphile Migrate:

   ```bash
   # Create a new migration
   pnpm migrate:watch
   # Make your database changes in the watch mode
   # Commit the migration
   pnpm migrate:commit
   ```

2. **Regenerate the GraphQL schema**:

   ```bash
   pnpm schema:generate
   ```

3. **Review the changes** in `packages/backend/schema.graphql`:

   - Check for breaking changes (removed fields, changed types, etc.)
   - Ensure backward compatibility
   - Update API documentation if needed

4. **Commit the updated schema**:
   ```bash
   git add packages/backend/schema.graphql
   git commit -m "Update GraphQL schema after database changes"
   ```

## CI Behavior

### On Pull Requests

The `schema-check` job will:

- ✅ **Pass** if the generated schema matches the committed file
- ❌ **Fail** if there are any differences, with a detailed diff showing the
  changes

### On Schema Mismatches

When the CI detects schema changes, it will:

1. Show a detailed diff of the changes
2. Upload the generated schema as an artifact for review
3. Provide clear instructions on how to update the committed schema

## Best Practices

1. **Always review schema changes** carefully before committing
2. **Consider backward compatibility** - breaking changes may affect existing
   clients
3. **Update API documentation** when making schema changes
4. **Test thoroughly** after schema changes to ensure everything works as
   expected
5. **Coordinate with frontend teams** when making breaking changes

## Troubleshooting

### Schema Generation Fails

- Ensure the database is running and accessible
- Check that all migrations have been applied
- Verify the database connection string is correct

### CI Schema Check Fails

- Review the diff shown in the CI logs
- If changes are intentional, regenerate and commit the updated schema
- If changes are unexpected, investigate what caused the schema to change

### Local vs CI Schema Differences

- Ensure your local database is up to date with migrations
- Check that you're using the same PostgreSQL version as CI
- Verify environment variables are set correctly

## Technical Details

The schema validation process uses:

- **PostGraphile**: Generates GraphQL schema from PostgreSQL database
- **GitHub Actions**: Runs validation in CI environment
- **PostgreSQL 15**: Database engine (same version as production)
- **Graphile Migrate**: Database migration tool

The validation runs in a clean environment with:

- Fresh PostgreSQL database
- All migrations applied
- Same configuration as production (minus sensitive settings)
